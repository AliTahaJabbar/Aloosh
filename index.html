<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="https://i.top4top.io/p_3450gatpo0.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>خدمات العصر الذكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f1f5f9;
        direction: rtl;
      }
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fade-in 0.5s ease-in-out;
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-in-out;
      }
      [contenteditable]:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        border-radius: 6px;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      }
      .text-shadow-lg {
        text-shadow: 0 4px 8px rgba(0,0,0,0.7);
      }
      
      /* تأثيرات تفاعلية جديدة */
      .hover-lift {
        transition: all 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      
      .hover-glow:hover {
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
      }
      
      .hover-scale {
        transition: transform 0.3s ease;
      }
      .hover-scale:hover {
        transform: scale(1.05);
      }
      
      .btn-interactive {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .btn-interactive:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
      }
      .btn-interactive:active {
        transform: translateY(1px);
      }
      
      .card-interactive {
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .card-interactive:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      
      .nav-link-interactive {
        transition: all 0.3s ease;
        position: relative;
      }
      .nav-link-interactive:hover {
        background-color: rgba(255, 255, 255, 0.15);
        transform: translateX(-5px);
      }
      
      .image-zoom-container {
        overflow: hidden;
        border-radius: 0.5rem;
      }
      .image-zoom {
        transition: transform 0.5s ease;
      }
      .image-zoom:hover {
        transform: scale(1.1);
      }
    </style>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useCallback, useRef } = React;

    // --- Helper function for non-blocking notifications ---
    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500');
        toast.className = `fixed top-5 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-[101] animate-fade-in-up`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 3000);
    };

    // --- From types.ts ---
    const Section = {
        Home: 'home',
        Maps: 'maps',
        Offers: 'offers',
        Vlans: 'vlans',
        Materials: 'materials',
        Maintenance: 'maintenance',
        Ports: 'ports',
        Contact: 'contact'
    };

    // --- From constants.ts ---
    const FOLLOWER_USERNAME = "متابع";
    const FOLLOWER_PASSWORD = "101001000";
    const ADMIN_USERNAME = "علي طه";
    const DEFAULT_ADMIN_PASSWORD = "199827";

    const INITIAL_DATA = {
      offers: {
        "115": [
          {
            title: "العرض الاول لزون 115 الخاص بالاعمدة (1 / 2 / 3 / 4 / 5 / 6 / 7 / 8 / 9 / 10 / 11 / 12 / 13 / 39)",
            table: [
              ["شهر", "15,000", "20,000", "30,000", "75,000"],
              ["ثلاث اشهر", "55,000", "75,000", "120,000", "180,000"]
            ],
            note: "العرض الأول (بدون سوبرسيل): الكيبل مجاني | الجهاز الضوئي بـ5,000 | الڤيلان : 710"
          },
          {
            title: "العرض الثاني لزون 115 الخاص بالاعمدة (14 / 15 / 16 / 18 / 19 / 22 / 23 / 24 / 25 / 26 / 28 / 30 / 32 / 34 / 35 / 36 / 37 / 38 / 41)",
            table: [
              ["شهر", "15,000", "20,000", "30,000", "75,000"],
              ["شهرين", "مجاني", "لايوجد", "لايوجد", "لايوجد"],
              ["ثلاث اشهر", "20,000", "75,000", "120,000", "180,000"]
            ],
            note: "العرض الثاني (مُشترك مع سوبرسيل): الكيبل مجاني | الجهاز الضوئي 5,000 | الڤيلان : 710"
          }
        ],
        "سوبر سيل حكومي": [{
          title: "عرض سوبر سيل حكومي",
          table: [
            ["شهر", "38,000", "48,000", "68,000", "غير متوفر"],
            ["3 أشهر", "غير متوفر", "غير متوفر", "غير متوفر", "غير متوفر"],
          ],
          note: "السرعات المذكورة تشمل اشتراكات الوطني فقط | الكيبل بـ10,000 | الجهاز الضوئي بـ10,000 | الڤيلان : 10",
        }],
      },
      maps: [
        {
          name: "وطني الدور",
          link: "https://www.google.com/maps/d/edit?mid=1ZLaIWvkNGXWzXBtS2qn3QnuICsF4MLw",
        },
      ],
      vlans: {
        "151": "210",
        "235": "317",
        "مجمع": "2",
      },
      materials: {
        routers: [
          {
            name: "راوتر TP-link BE3000 Wifi 7",
            price: "السعر : 90.000 د.ع",
            image: "https://dc585.4shared.com/img/5YBFGXfZfa/s24/1993358aed0/_TP-link_BE3000_Wifi_7?async&rand=0.8962375215610101",
            specs: [
              "Wifi : الجيل السابع (الاحدث والاسرع) (Wifi 7)",
              "التغطية: ممتازة للمنازل المتوسطة إلى الكبيرة مع 4 هوائيات خارجية قوية",
              "السرعة: السرعة سلكياً : منفذ WAN بسرعة 2.5G و4 منافذ LAN المنفذ الأول بسرعة 2.5G والمنافذ الثلاث الباقية بسرعة 1G || السرعة الاسلكية : تصل تقريباً 3000Mbps  (574Mbps على 2.4GHz و2402Mbps على 5GHz).",
              "تحمّل الأجهزة: يدعم MU-MIMO، Beamforming وWPA3، لتوزيع أفضل للإشارة على أجهزة متعددة وتقليل التداخل.",
              " للألعاب والبث: أداء فائق جدًا للبث بدقة 4K وألعاب أونلاين بدون لاكَ أو تقطيع بفضل خاصية MOL و OFDMA ."
            ],
          },
        ],
        onu: [],
        ont: [],
        other: [],
      },
      ports: [
        {
          area: "الدولعي",
          zone: "162",
          name: "مكتب سنتر بغداد",
          landmark: "مقابيل مدرسة ابن الحوزي",
          coordinates: "33.36311, 44.30947"
        },
        {
          area: "الدور",
          zone: "115",
          name: "سنتر الدور الرئيسي",
          landmark: "قرب سوق الدور المركزي",
          coordinates: "33.35215, 44.30245"
        }
      ],
      maintenanceNumbers: [
        { area: "منطقة (الدور والسلام والمجمع)", number: "07765991787" },
        { area: "منطقة حي العدل", number: "07719327451" },
        { area: "منطقة (الاولى والثالثة والبستان وربيع ودباش)", number: "07738494801" },
        { area: "منطقة ربيع ودباش", number: "07838755260" },
        { area: "منطقة الثانية", number: "07750633390" },
        { area: "منطقة الدولعي", number: "07859024132" },
        { area: "منطقة جكوك", number: "07858478756" },
        { area: "منطقة السيدية وحي العامل", number: "07838514192 او 07848775048" },
        { area: "رقم سوبرسيل حكومي", number: "07781050006" },
        { area: "رقم الشكاوي", number: "07759313075" }
      ],
      stickers: [
        { name: 'ستيكر وطني الدور وحي العدل', thumb: 'https://dc585.4shared.com/img/jzCZFS6Iku/s24/1993374b698/____?async&rand=0.08830512109580269' },
        { name: 'ستيكر السلام والزراعي والمجمع وسوبرسيل', thumb: 'https://dc730.4shared.com/img/2IMubdtljq/s24/1993374a6f8/____?async&rand=0.2608503140747772' },
        { name: 'ستيكر وطني (الاولى والثانية والثالثة والبستان وربيع ودباش)', thumb: 'https://dc730.4shared.com/img/NBIC_b16ku/s24/1993374b2b0/_________?async&rand=0.7303803786917789' },
        { name: 'ستيكر جكوك والدولعي', thumb: 'https://dc730.4shared.com/img/2N4HIxMtjq/s24/1993374aec8/___online?async&rand=0.550228095590632' }
      ]
    };

    // --- Firebase Configuration ---
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCUuyJB3dI1R2keBFB34epgZz7_ELDPHQs",
      authDomain: "smart-age-services-42aa2.firebaseapp.com",
      databaseURL: "https://smart-age-services-42aa2-default-rtdb.firebaseio.com",
      projectId: "smart-age-services-42aa2",
      storageBucket: "smart-age-services-42aa2.firebasestorage.app",
      messagingSenderId: "845608614683",
      appId: "1:845608614683:web:37deeb7c45bad45113f1be",
      measurementId: "G-G2DCJEMXWB"
    };

    // --- From contexts/AuthContext.tsx ---
    const AuthContext = createContext(undefined);

    const AuthProvider = ({ children }) => {
      const [userRole, setUserRole] = useState(null);
      const [userData, setUserData] = useState(null);

      useEffect(() => {
        const storedAuth = localStorage.getItem('smartAgeAuth');
        if (storedAuth) {
          try {
            const authData = JSON.parse(storedAuth);
            setUserRole(authData.role);
            setUserData(authData);
          } catch (e) {
            console.error("Error parsing stored auth data:", e);
            localStorage.removeItem('smartAgeAuth');
          }
        }
      }, []);

      const login = (role, username, password) => {
        let userInfo = { role, username, loginTime: new Date().toISOString() };
        
        if (role === 'teamLeader') {
          userInfo = { ...userInfo, id: 'teamLeader', name: 'قائد فريق' };
          localStorage.setItem('smartAgeAuth', JSON.stringify(userInfo));
          setUserRole(role);
          setUserData(userInfo);
          return true;
        }
        if (role === 'follower' && username === FOLLOWER_USERNAME && password === FOLLOWER_PASSWORD) {
          userInfo = { ...userInfo, id: 'follower', name: 'متابع' };
          localStorage.setItem('smartAgeAuth', JSON.stringify(userInfo));
          setUserRole(role);
          setUserData(userInfo);
          return true;
        }
        if (role === 'admin' && username === ADMIN_USERNAME) {
          const adminPassword = localStorage.getItem("smartAgeAdminPassword") || DEFAULT_ADMIN_PASSWORD;
          if (password === adminPassword) {
            userInfo = { ...userInfo, id: 'admin', name: 'مسؤول' };
            localStorage.setItem('smartAgeAuth', JSON.stringify(userInfo));
            setUserRole(role);
            setUserData(userInfo);
            return true;
          }
        }
        return false;
      };

      const logout = () => {
        localStorage.removeItem('smartAgeAuth');
        setUserRole(null);
        setUserData(null);
        window.location.reload();
      };

      const changePassword = (current, newPass) => {
        if (userRole !== 'admin') return false;
        const currentAdminPassword = localStorage.getItem("smartAgeAdminPassword") || DEFAULT_ADMIN_PASSWORD;
        if (current === currentAdminPassword) {
            localStorage.setItem("smartAgeAdminPassword", newPass);
            return true;
        }
        return false;
      };

      return (
        <AuthContext.Provider value={{ userRole, userData, login, logout, changePassword }}>
          {children}
        </AuthContext.Provider>
      );
    };

    const useAuth = () => {
      const context = useContext(AuthContext);
      if (context === undefined) {
        throw new Error('useAuth must be used within an AuthProvider');
      }
      return context;
    };

    // --- From contexts/DataContext.tsx ---
    const DataContext = createContext(undefined);

    const DataProvider = ({ children }) => {
        const { userRole, userData } = useAuth();
        const [data, setData] = useState(INITIAL_DATA);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
        const [lastSaveTime, setLastSaveTime] = useState(null);
        
        const [firebaseInitialized, setFirebaseInitialized] = useState(false);
        const [isConnectedToFirebase, setIsConnectedToFirebase] = useState(false);
        const [syncStatus, setSyncStatus] = useState('UNINITIALIZED');
        const [lastSyncTime, setLastSyncTime] = useState(null);
        const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
        const [isLoading, setIsLoading] = useState(true);
        
        const canWriteToFirebase = userRole === 'admin'; // الكتابة فقط للمسؤول
        const canReadFromFirebase = !!userRole; // القراءة لجميع المستخدمين المسجلين

        // تهيئة Firebase
        useEffect(() => {
            try {
                if (window.firebase) {
                    window.firebase.initializeApp(FIREBASE_CONFIG);
                    setFirebaseInitialized(true);
                    
                    // مراقبة حالة الاتصال
                    const db = window.firebase.database();
                    const connectedRef = db.ref(".info/connected");
                    connectedRef.on("value", (snap) => {
                        setIsConnectedToFirebase(snap.val() === true);
                    });
                    
                } else {
                    console.error("Firebase SDK not loaded");
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }, []);

        // الاستماع للتحديثات الفورية من Firebase لجميع المستخدمين
        useEffect(() => {
            if (!firebaseInitialized || !canReadFromFirebase) return;

            setSyncStatus('SYNCING');
            setIsLoading(true);
            
            try {
                const db = window.firebase.database();
                const siteDataRef = db.ref('siteData');
                
                // الاستماع للتحديثات الفورية
                siteDataRef.on('value', (snapshot) => {
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData) {
                        setData(firebaseData);
                        setSyncStatus('SYNCED');
                        setLastSyncTime(new Date());
                        setHasUnsavedChanges(false);
                        setIsLoading(false);
                        
                        // عرض إشعار بالتحديثات الجديدة (باستثناء التحميل الأول)
                        if (lastSyncTime) {
                            showToast('تم تحديث البيانات بأحدث التغييرات', 'info');
                        }
                    } else {
                        // إذا لم تكن هناك بيانات في Firebase، استخدم البيانات الابتدائية
                        setData(INITIAL_DATA);
                        setSyncStatus('SYNCED');
                        setLastSyncTime(new Date());
                        setHasUnsavedChanges(false);
                        setIsLoading(false);
                        
                        // إذا كان المستخدم مسؤولاً، يمكنه إنشاء البيانات الابتدائية
                        if (canWriteToFirebase) {
                            showToast('لا توجد بيانات في السحابة، يمكنك إنشاء بيانات جديدة', 'info');
                        }
                    }
                }, (error) => {
                    console.error("Error listening to Firebase:", error);
                    setSyncStatus('ERROR');
                    setIsLoading(false);
                    showToast('فشل الاتصال بالسحابة', 'error');
                });
                
            } catch (error) {
                console.error("Error setting up Firebase listener:", error);
                setSyncStatus('ERROR');
                setIsLoading(false);
            }

            // تنظيف الـ listener عند إلغاء التثبيت
            return () => {
                if (window.firebase) {
                    const db = window.firebase.database();
                    db.ref('siteData').off();
                }
            };
        }, [firebaseInitialized, canReadFromFirebase]);

        // حفظ البيانات تلقائياً عند التغيير (للمسؤول فقط)
        useEffect(() => {
            if (hasUnsavedChanges && autoSaveEnabled && canWriteToFirebase) {
                const autoSaveTimer = setTimeout(() => {
                    if (isConnectedToFirebase) {
                        saveDataToFirebase(data);
                    }
                }, 2000);

                return () => clearTimeout(autoSaveTimer);
            }
        }, [hasUnsavedChanges, data, autoSaveEnabled, canWriteToFirebase, isConnectedToFirebase]);

        const saveDataToFirebase = useCallback(async (dataToSave) => {
            if (!firebaseInitialized || !isConnectedToFirebase) {
                console.error('Firebase not initialized or not connected');
                showToast('لا يمكن الحفظ بسبب عدم الاتصال بالسحابة', 'error');
                return false;
            }
            
            if (!canWriteToFirebase) {
                showToast('ليس لديك صلاحية لحفظ البيانات', 'error');
                return false;
            }
            
            setSyncStatus('SYNCING');
            try {
                const db = window.firebase.database();
                await db.ref('siteData').set(dataToSave);
                
                setSyncStatus('SYNCED');
                setLastSyncTime(new Date());
                setHasUnsavedChanges(false);
                setLastSaveTime(new Date());
                showToast('تم حفظ البيانات في السحابة بنجاح!', 'success');
                return true;
            } catch (error) {
                console.error("Error saving data to Firebase:", error);
                setSyncStatus('ERROR');
                showToast('فشل حفظ البيانات في السحابة.', 'error');
                return false;
            }
        }, [firebaseInitialized, isConnectedToFirebase, canWriteToFirebase]);

        const saveData = useCallback(async () => {
            if (canWriteToFirebase && isConnectedToFirebase) {
                const success = await saveDataToFirebase(data);
                return success;
            } else {
                showToast('لا يمكن الحفظ بسبب عدم الاتصال أو عدم وجود صلاحية', 'error');
                return false;
            }
        }, [canWriteToFirebase, isConnectedToFirebase, data, saveDataToFirebase]);

        const updateData = useCallback((newData) => {
            setData(newData);
            setHasUnsavedChanges(true);
        }, []);

        const updateField = useCallback((path, value) => {
            setData(currentData => {
                const newData = JSON.parse(JSON.stringify(currentData));
                let current = newData;
                const keys = path.split('.');
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
                return newData;
            });
            setHasUnsavedChanges(true);
        }, []);

        // إعادة تعيين البيانات إلى القيم الافتراضية (للمسؤول فقط)
        const resetToInitialData = useCallback(() => {
            if (window.confirm('هل تريد حقاً إعادة تعيين جميع البيانات إلى القيم الافتراضية؟ سيتم فقدان جميع التغييرات غير المحفوظة.')) {
                setData(INITIAL_DATA);
                setHasUnsavedChanges(true);
                showToast('تم إعادة تعيين البيانات إلى القيم الافتراضية', 'info');
            }
        }, []);

        const toggleAutoSave = useCallback(() => {
            setAutoSaveEnabled(prev => !prev);
            showToast(`الحفظ التلقائي ${!autoSaveEnabled ? 'مفعل' : 'معطل'}`, 'info');
        }, [autoSaveEnabled]);

        return (
            <DataContext.Provider value={{ 
                data, 
                updateData, 
                updateField, 
                saveData,
                resetToInitialData,
                hasUnsavedChanges,
                lastSaveTime,
                syncStatus, 
                lastSyncTime, 
                isConnectedToFirebase, 
                firebaseInitialized,
                autoSaveEnabled,
                toggleAutoSave,
                canWriteToFirebase,
                canReadFromFirebase,
                isLoading
            }}>
                {children}
            </DataContext.Provider>
        );
    };

    const useData = () => {
        const context = useContext(DataContext);
        if (context === undefined) {
            throw new Error('useData must be used within a DataProvider');
        }
        return context;
    };
    
    // --- Save Button Component ---
    const SaveButton = ({ section }) => {
        const { saveData, hasUnsavedChanges, lastSaveTime, autoSaveEnabled, canWriteToFirebase } = useData();

        if (!canWriteToFirebase) return null;

        if (!hasUnsavedChanges) {
            return lastSaveTime ? (
                <div className="fixed bottom-6 left-6 z-40">
                    <div className="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 btn-interactive">
                        <i className="fas fa-check"></i>
                        <span>آخر حفظ: {lastSaveTime.toLocaleTimeString()}</span>
                    </div>
                </div>
            ) : null;
        }

        return (
            <div className="fixed bottom-6 left-6 z-40">
                <button
                    onClick={saveData}
                    className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 transition-all btn-interactive"
                >
                    <i className="fas fa-save"></i>
                    {autoSaveEnabled ? `جاري الحفظ التلقائي...` : `حفظ ${section}`}
                </button>
            </div>
        );
    };

    // --- From components/Modal.tsx ---
    const Modal = ({ title, children, onClose, footer }) => {
        return (
            <div
                className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[100]"
                onClick={onClose}
            >
                <div
                    className="bg-white rounded-lg shadow-xl w-full max-w-md m-4 animate-fade-in-up hover-lift"
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="flex justify-between items-center p-4 border-b">
                        <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                        <button
                            onClick={onClose}
                            className="text-slate-400 hover:text-slate-800 text-2xl btn-interactive"
                        >
                            &times;
                        </button>
                    </div>
                    <div className="p-6">{children}</div>
                    {footer && (
                        <div className="flex justify-end gap-3 p-4 bg-slate-50 border-t rounded-b-lg">
                            {footer}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- Image Modal Component ---
    const ImageModal = ({ src, alt, onClose }) => {
        return (
            <div
                className="fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center z-[100]"
                onClick={onClose}
            >
                <div className="max-w-4xl max-h-full p-4" onClick={(e) => e.stopPropagation()}>
                    <button
                        onClick={onClose}
                        className="absolute top-4 left-4 text-white text-2xl bg-black/50 rounded-full w-10 h-10 flex items-center justify-center btn-interactive"
                    >
                        &times;
                    </button>
                    <img 
                        src={src} 
                        alt={alt} 
                        className="max-w-full max-h-full object-contain rounded-lg shadow-2xl hover-scale" 
                    />
                </div>
            </div>
        );
    };

    // --- From components/ChangePasswordModal.tsx ---
    const ChangePasswordModal = ({ setIsOpen }) => {
        const [currentPassword, setCurrentPassword] = useState('');
        const [newPassword, setNewPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [error, setError] = useState('');
        const { changePassword } = useAuth();

        const handleSubmit = () => {
            if (newPassword !== confirmPassword) {
                setError("كلمة المرور الجديدة غير متطابقة.");
                return;
            }
            if (newPassword.length < 4) {
                setError("كلمة المرور الجديدة يجب أن تكون على الأقل 4 أحرف.");
                return;
            }

            if (changePassword(currentPassword, newPassword)) {
                showToast("تم تغيير كلمة المرور بنجاح.", "success");
                setIsOpen(false);
            } else {
                setError("كلمة المرور الحالية غير صحيحة.");
            }
        };

        return (
            <Modal title="تغيير كلمة المرور" onClose={() => setIsOpen(false)}>
                <div className="space-y-4 text-right">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">كلمة المرور الحالية</label>
                        <input
                            type="password"
                            value={currentPassword}
                            onChange={(e) => setCurrentPassword(e.target.value)}
                            className="w-full p-2 border-2 border-slate-300 rounded-md focus:border-blue-500 transition-colors"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">كلمة المرور الجديدة</label>
                        <input
                            type="password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            className="w-full p-2 border-2 border-slate-300 rounded-md focus:border-blue-500 transition-colors"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">تأكيد كلمة المرور الجديدة</label>
                        <input
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            className="w-full p-2 border-2 border-slate-300 rounded-md focus:border-blue-500 transition-colors"
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                </div>
                <div className="mt-6 flex justify-end gap-3">
                    <button onClick={() => setIsOpen(false)} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 btn-interactive">إلغاء</button>
                    <button onClick={handleSubmit} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 btn-interactive">حفظ</button>
                </div>
            </Modal>
        );
    };

    // --- From components/Login.tsx ---
    const Login = () => {
        const [view, setView] = useState('options');
        const [loginType, setLoginType] = useState(null);
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const { login } = useAuth();

        const handleShowForm = (type) => {
            setLoginType(type);
            setView('form');
            setError('');
            setUsername('');
            setPassword('');
        };

        const handleLogin = (e) => {
            e.preventDefault();
            if (!login(loginType, username, password)) {
                setError('اسم المستخدم أو كلمة المرور غير صحيحة.');
            }
        };

        return (
            <div id="login-overlay" className="fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center z-50">
                <div className="login-container bg-white p-10 rounded-lg shadow-2xl w-full max-w-sm text-center animate-fade-in hover-lift">
                    <h2 className="text-2xl font-bold mb-6 text-slate-800">تسجيل الدخول</h2>
                    
                    {view === 'options' && (
                        <div id="login-options" className="space-y-4">
                            <button
                                onClick={() => login('teamLeader')}
                                className="w-full py-3 px-4 bg-blue-500 text-white rounded-lg font-semibold text-lg hover:bg-blue-600 transition-colors btn-interactive"
                            >
                                الدخول كقائد فريق
                            </button>
                            <button
                                onClick={() => handleShowForm('follower')}
                                className="w-full py-3 px-4 bg-slate-100 text-slate-800 rounded-lg font-semibold text-lg border-2 border-slate-300 hover:bg-slate-200 transition-colors btn-interactive"
                            >
                                الدخول كمتابع
                            </button>
                            <button
                                onClick={() => handleShowForm('admin')}
                                className="w-full py-3 px-4 bg-red-500 text-white rounded-lg font-semibold text-lg hover:bg-red-600 transition-colors btn-interactive"
                            >
                                الدخول كمسؤول
                            </button>
                        </div>
                    )}

                    {view === 'form' && (
                        <form id="login-form" className="text-right" onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label htmlFor="username" className="block mb-1 font-semibold text-slate-700">اسم المستخدم</label>
                                <input
                                    type="text"
                                    id="username"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition hover-lift"
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="password" className="block mb-1 font-semibold text-slate-700">كلمة المرور</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition hover-lift"
                                    required
                                />
                            </div>
                            {error && <p id="login-error" className="text-red-500 text-sm text-center mb-2 h-5">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors btn-interactive">
                                دخول
                            </button>
                            <button
                                type="button"
                                onClick={() => setView('options')}
                                className="w-full mt-3 py-2 bg-slate-100 text-slate-800 rounded-lg font-semibold border-2 border-slate-300 hover:bg-slate-200 transition-colors btn-interactive"
                            >
                                رجوع
                            </button>
                        </form>
                    )}
                </div>
            </div>
        );
    };

    // --- From components/Layout.tsx ---
    const FirebaseSyncButton = ({ isMobile = false }) => {
        const { 
            syncStatus, 
            lastSyncTime,
            isConnectedToFirebase,
            firebaseInitialized,
            canWriteToFirebase,
            autoSaveEnabled,
            toggleAutoSave,
            isLoading
        } = useData();

        if (!firebaseInitialized) {
            return (
                <div className="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-slate-400">
                    <i className="fas fa-spinner fa-spin"></i>
                    <span>جاري تحميل السحابة...</span>
                </div>
            );
        }
        
        if (isLoading) {
            return (
                <div className={`flex items-center gap-2 text-sm font-semibold text-yellow-500 ${isMobile ? 'w-full justify-center' : ''}`}>
                    <i className="fas fa-spinner fa-spin"></i>
                    <span>جاري تحميل البيانات...</span>
                </div>
            );
        }
        
        if (!isConnectedToFirebase) {
            return (
                <div className={`flex items-center gap-2 text-sm font-semibold text-red-400 ${isMobile ? 'w-full justify-center' : ''}`}>
                    <i className="fas fa-wifi-slash"></i>
                    <span>غير متصل بالسحابة</span>
                </div>
            );
        }
        
        let statusIcon, statusText, statusColor;
        switch (syncStatus) {
            case 'SYNCING':
                statusIcon = 'fas fa-sync fa-spin';
                statusText = 'جاري المزامنة...';
                statusColor = 'text-yellow-400';
                break;
            case 'SYNCED':
                statusIcon = 'fas fa-check-circle';
                statusText = `محدث: ${lastSyncTime?.toLocaleTimeString()}`;
                statusColor = 'text-green-400';
                break;
            case 'ERROR':
                statusIcon = 'fas fa-exclamation-triangle';
                statusText = 'خطأ في المزامنة';
                statusColor = 'text-red-400';
                break;
            default:
                statusIcon = 'fas fa-cloud';
                statusText = 'متصل بالسحابة';
                statusColor = 'text-blue-400';
        }

        return (
            <div className={`flex items-center gap-3 ${isMobile ? 'w-full' : ''}`}>
                {canWriteToFirebase && (
                    <button 
                        onClick={toggleAutoSave}
                        className={`text-xs px-2 py-1 rounded transition-colors btn-interactive ${
                            autoSaveEnabled 
                                ? 'bg-green-500 text-white hover:bg-green-600' 
                                : 'bg-slate-300 text-slate-600 hover:bg-slate-400'
                        }`}
                        title={autoSaveEnabled ? 'تعطيل الحفظ التلقائي' : 'تفعيل الحفظ التلقائي'}
                    >
                        <i className={`fas ${autoSaveEnabled ? 'fa-toggle-on' : 'fa-toggle-off'}`}></i>
                    </button>
                )}
                <div className={`flex items-center gap-2 ${statusColor} text-sm font-semibold`}>
                    <i className={statusIcon}></i>
                    <span>{statusText}</span>
                </div>
            </div>
        );
    }

    const NavLink = ({ section, icon, label, activeSection, setActiveSection, hiddenFor = [], closeMobileNav }) => {
        const { userRole } = useAuth();
        if (userRole && hiddenFor.includes(userRole)) {
            return null;
        }
        const isActive = activeSection === section;
        
        const handleClick = (e) => {
            e.preventDefault();
            setActiveSection(section);
            if (closeMobileNav) {
                closeMobileNav();
            }
        };

        return (
            <li>
                <a
                    href="#"
                    onClick={handleClick}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors duration-300 whitespace-nowrap nav-link-interactive ${
                        isActive ? 'bg-white/10' : 'hover:bg-white/10'
                    }`}
                >
                    <i className={`fas ${icon}`}></i>
                    <span>{label}</span>
                </a>
            </li>
        );
    };

    const Layout = ({children, activeSection, setActiveSection}) => {
        const { userRole, logout, userData } = useAuth();
        const { resetToInitialData } = useData();
        const [isMobileNavOpen, setMobileNavOpen] = useState(false);
        const [isPasswordModalOpen, setPasswordModalOpen] = useState(false);

        const roleText = {
            follower: 'المتابع',
            teamLeader: 'قائد فريق',
            admin: 'المسؤول',
        };

        const navLinks = [
            { section: Section.Home, icon: 'fa-home', label: 'الرئيسية' },
            { section: Section.Maps, icon: 'fa-map', label: 'الخرائط' },
            { section: Section.Offers, icon: 'fa-percent', label: 'العروض', hiddenFor: ['teamLeader'] },
            { section: Section.Vlans, icon: 'fa-network-wired', label: 'الفيلانات' },
            { section: Section.Materials, icon: 'fa-microchip', label: 'المواد' },
            { section: Section.Maintenance, icon: 'fa-tools', label: 'الصيانة' },
            { section: Section.Ports, icon: 'fa-ethernet', label: 'المنافذ' },
            { section: Section.Contact, icon: 'fa-phone', label: 'اتصل بنا' },
        ];

        return (
            <>
                <header className="bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg sticky top-0 z-40">
                    <div className="container mx-auto px-4 flex justify-between items-center h-16">
                        <div className="flex items-center gap-3">
                            <img src="https://dc585.4shared.com/img/O-lyn4tEku/s24/19933795a18/_online?async&rand=0.6523859132132545" alt="Logo" className="h-10 hover-scale" />
                            <span className="text-xl font-bold whitespace-nowrap">شركة العصر الذكي</span>
                        </div>
                        
                        <nav className="hidden xl:flex">
                            <ul className="flex items-center gap-2">
                                {navLinks.map(link => <NavLink key={link.section} {...link} activeSection={activeSection} setActiveSection={setActiveSection} />)}
                            </ul>
                        </nav>

                        <div className="flex items-center gap-4">
                            <div className="hidden xl:flex items-center gap-4">
                                <FirebaseSyncButton />
                                <div className="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg hover-lift">
                                    <i className="fas fa-user-circle text-blue-400 text-xl"></i>
                                    <span className="font-semibold text-sm">{userRole ? roleText[userRole] : ''}</span>
                                </div>
                                {userRole === 'admin' && (
                                    <>
                                        <button onClick={() => setPasswordModalOpen(true)} className="flex items-center gap-2 text-sm font-semibold border-2 border-yellow-500 text-yellow-500 px-3 py-1.5 rounded-lg hover:bg-yellow-500 hover:text-slate-900 transition-colors btn-interactive">
                                            <i className="fas fa-key"></i>
                                        </button>
                                        <button onClick={resetToInitialData} className="flex items-center gap-2 text-sm font-semibold border-2 border-purple-500 text-purple-500 px-3 py-1.5 rounded-lg hover:bg-purple-500 hover:text-white transition-colors btn-interactive" title="إعادة تعيين البيانات">
                                            <i className="fas fa-redo"></i>
                                        </button>
                                    </>
                                )}
                                <button onClick={logout} className="flex items-center gap-2 text-sm font-semibold border-2 border-red-500 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-500 hover:text-white transition-colors btn-interactive">
                                    <i className="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                            <button className="xl:hidden text-2xl btn-interactive" onClick={() => setMobileNavOpen(true)}>
                                <i className="fas fa-bars"></i>
                            </button>
                        </div>
                    </div>
                </header>

                {/* Mobile Nav */}
                <div className={`fixed top-0 right-0 h-full w-72 bg-slate-800 z-50 transform transition-transform duration-300 ease-in-out ${isMobileNavOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                    <div className="p-4 flex justify-between items-center border-b border-white/10">
                        <span className="text-lg font-bold text-white">القائمة</span>
                        <button onClick={() => setMobileNavOpen(false)} className="text-2xl text-white btn-interactive">
                            <i className="fas fa-times"></i>
                        </button>
                    </div>
                    <nav className="p-4">
                        <ul className="flex flex-col gap-2 text-white">
                            {navLinks.map(link => <NavLink key={link.section} {...link} activeSection={activeSection} setActiveSection={setActiveSection} closeMobileNav={() => setMobileNavOpen(false)} />)}
                        </ul>
                    </nav>
                    <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-white/10 flex flex-col gap-3">
                        <FirebaseSyncButton isMobile={true} />
                        <div className="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg text-sm text-white hover-lift">
                                <i className="fas fa-user-circle text-blue-400 text-xl"></i>
                                <span className="font-semibold">{userRole ? roleText[userRole] : ''}</span>
                            </div>
                            {userRole === 'admin' && (
                                <>
                                    <button onClick={() => {setPasswordModalOpen(true); setMobileNavOpen(false)}} className="w-full flex items-center justify-center gap-2 text-sm font-semibold border-2 border-yellow-500 text-yellow-500 px-3 py-1.5 rounded-lg hover:bg-yellow-500 hover:text-slate-900 transition-colors btn-interactive">
                                        <i className="fas fa-key"></i>
                                        <span>تغيير كلمة المرور</span>
                                    </button>
                                    <button onClick={() => {resetToInitialData(); setMobileNavOpen(false);}} className="w-full flex items-center justify-center gap-2 text-sm font-semibold border-2 border-purple-500 text-purple-500 px-3 py-1.5 rounded-lg hover:bg-purple-500 hover:text-white transition-colors btn-interactive">
                                        <i className="fas fa-redo"></i>
                                        <span>إعادة تعيين البيانات</span>
                                    </button>
                                </>
                            )}
                            <button onClick={logout} className="w-full flex items-center justify-center gap-2 text-sm font-semibold border-2 border-red-500 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-500 hover:text-white transition-colors btn-interactive">
                                <i className="fas fa-sign-out-alt"></i>
                                <span>تسجيل الخروج</span>
                            </button>
                    </div>
                </div>
                {isMobileNavOpen && <div className="fixed inset-0 bg-black/60 z-40 xl:hidden" onClick={() => setMobileNavOpen(false)}></div>}

                <main className="bg-slate-100">
                    {children}
                </main>
                
                <footer className="bg-slate-800 text-white mt-16">
                    <div className="container mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 text-center md:text-right">
                            <div>
                                <h3 className="text-xl font-bold mb-4 border-b-2 border-blue-500 pb-2 inline-block">عن الشركة</h3>
                                <p className="text-slate-300 text-sm">شركة إنترنت رائدة في تقديم خدمات الإنترنت عالية الجودة والحلول التقنية المتطورة لعملائنا في جميع المناطق.</p>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold mb-4 border-b-2 border-blue-500 pb-2 inline-block">روابط سريعة</h3>
                                <ul className="text-slate-300 space-y-2 text-sm">
                                {navLinks.map(link => (
                                    <li key={`footer-${link.section}`} className={(link.hiddenFor && userRole && link.hiddenFor.includes(userRole)) ? 'hidden' : ''}>
                                        <a href="#" onClick={(e) => { e.preventDefault(); setActiveSection(link.section); window.scrollTo(0,0); }} className="hover:text-blue-400 transition-colors nav-link-interactive">
                                            <i className={`fas ${link.icon} ml-2`}></i>{link.label}
                                        </a>
                                    </li>
                                ))}
                                </ul>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold mb-4 border-b-2 border-blue-500 pb-2 inline-block">معلومات الاتصال</h3>
                                <div className="text-slate-300 space-y-2 text-sm">
                                    <p><i className="fas fa-map-marker-alt ml-2 text-blue-400"></i>العنوان: الحرية, الدور, قرب مصور عيسى</p>
                                    <p><i className="fas fa-phone ml-2 text-blue-400"></i>الهاتف: 07838102085</p>
                                    <p><i className="fas fa-envelope ml-2 text-blue-400"></i>البريد: alitahasmartnet@gmail.com</p>
                                </div>
                            </div>
                        </div>
                        <div className="text-center pt-4 border-t border-white/10 text-xs text-slate-400">
                            <p>شركة العصر الذكي &copy; {new Date().getFullYear()}</p>
                        </div>
                    </div>
                </footer>

                {isPasswordModalOpen && <ChangePasswordModal setIsOpen={setPasswordModalOpen} />}
            </>
        );
    };
    
    // --- From sections/Home.tsx ---
    const ServiceCard = ({ imgSrc, title, description, section, setActiveSection }) => {
        const [isImageModalOpen, setImageModalOpen] = useState(false);

        return (
            <>
                <div className="bg-white rounded-lg shadow-lg overflow-hidden card-interactive">
                    <div className="h-44 overflow-hidden image-zoom-container cursor-pointer" onClick={() => setImageModalOpen(true)}>
                        <img src={imgSrc} alt={title} className="w-full h-full object-cover image-zoom" />
                    </div>
                    <div className="p-5">
                        <h3 className="text-xl font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-600 mb-4 text-sm">{description}</p>
                        <button onClick={() => setActiveSection(section)} className="font-semibold text-blue-500 hover:text-blue-600 btn-interactive">
                            استعرض الآن <i className="fas fa-arrow-left mr-2"></i>
                        </button>
                    </div>
                </div>
                {isImageModalOpen && (
                    <ImageModal 
                        src={imgSrc} 
                        alt={title} 
                        onClose={() => setImageModalOpen(false)} 
                    />
                )}
            </>
        );
    };

    const Home = ({ setActiveSection }) => {
        const { isLoading } = useData();

        if (isLoading) {
            return (
                <div className="animate-fade-in flex justify-center items-center h-64">
                    <div className="text-center">
                        <i className="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p className="text-slate-600">جاري تحميل البيانات...</p>
                    </div>
                </div>
            );
        }

        return (
            <div className="animate-fade-in">
                <section className="hero bg-cover bg-center h-[65vh] flex items-center justify-center text-white" style={{backgroundImage: "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('https://dc585.4shared.com/img/B9PkdLWRfa/s24/1993358aae8/_online?async&rand=0.5108986475801636')"}}>
                    <div className="text-center max-w-3xl px-4">
                        <h1 className="text-4xl md:text-5xl font-extrabold mb-4 text-shadow-lg">خدمات إنترنت فائقة السرعة</h1>
                        <p className="text-lg md:text-xl mb-6 text-shadow">نقدم لكم أحدث حلول الإنترنت والاتصالات مع أفضل الخدمات التقنية والدعم الفني المتميز.</p>
                    </div>
                </section>

                <div className="container mx-auto px-4 py-16">
                    <h2 className="text-3xl font-bold text-center mb-12 text-slate-800 relative after:content-[''] after:absolute after:w-20 after:h-1 after:bg-blue-500 after:left-1/2 after:-translate-x-1/2 after:bottom-[-10px] after:rounded-full">خدماتنا</h2>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <ServiceCard
                            imgSrc="https://dc585.4shared.com/img/TpHWOgkfge/s24/199335dee90/_online?async&rand=0.9971719481601765"
                            title="خرائط المناطق"
                            description="استكشف خرائط الشبكة التفصيلية لجميع المناطق."
                            section={Section.Maps}
                            setActiveSection={setActiveSection}
                        />
                        <ServiceCard
                            imgSrc="https://dc525.4shared.com/img/exrQ5Iyjfa/s24/1993358a318/_online?async&rand=0.6069926996845987"
                            title="العروض والخصومات"
                            description="اكتشف أحدث العروض والخصومات على باقات الإنترنت."
                            section={Section.Offers}
                            setActiveSection={setActiveSection}
                        />
                        <ServiceCard
                            imgSrc="https://dc585.4shared.com/img/1jFK99w6ge/s24/19933619fe0/__online?async&rand=0.9196284863098757"
                            title="الأجهزة والمواد"
                            description="تصفح أحدث أجهزة الإنترنت والمواد التقنية."
                            section={Section.Materials}
                            setActiveSection={setActiveSection}
                        />
                    </div>
                </div>
            </div>
        );
    };

    // --- From sections/Maps.tsx ---
    const Maps = () => {
        const { data, updateData, isLoading } = useData();
        const { userRole } = useAuth();
        const [searchTerm, setSearchTerm] = useState('');
        const [showForm, setShowForm] = useState(false);
        const [formData, setFormData] = useState({ name: '', link: '' });
        const [editingIndex, setEditingIndex] = useState(null);

        if (isLoading) {
            return (
                <div className="container mx-auto px-4 py-12 animate-fade-in flex justify-center items-center h-64">
                    <div className="text-center">
                        <i className="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p className="text-slate-600">جاري تحميل البيانات...</p>
                    </div>
                </div>
            );
        }

        const filteredMaps = data.maps.filter(map =>
            map.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        const handleAddNewClick = () => {
            setEditingIndex(null);
            setFormData({ name: '', link: '' });
            setShowForm(true);
        };

        const handleEditClick = (index) => {
            setEditingIndex(index);
            setFormData(data.maps[index]);
            setShowForm(true);
        };

        const handleSaveMap = () => {
            if (formData.name && formData.link) {
                const newMaps = [...data.maps];
                if (editingIndex !== null) {
                    newMaps[editingIndex] = formData;
                } else {
                    newMaps.push(formData);
                }
                updateData({ ...data, maps: newMaps });
                setShowForm(false);
            }
        };

        const handleDeleteMap = (index) => {
            const newMaps = [...data.maps];
            newMaps.splice(index, 1);
            updateData({ ...data, maps: newMaps });
        };

        const handleSearch = () => {
            // البحث يتم تلقائياً عبر filteredMaps
        };

        return (
            <section className="container mx-auto px-4 py-12 animate-fade-in">
                <h2 className="text-3xl font-bold text-center mb-12 text-slate-800 relative after:content-[''] after:absolute after:w-20 after:h-1 after:bg-blue-500 after:left-1/2 after:-translate-x-1/2 after:bottom-[-10px] after:rounded-full">خرائط المناطق</h2>
                
                <div className="max-w-xl mx-auto mb-8">
                    <div className="flex gap-2">
                        <input
                            type="text"
                            placeholder="ابحث عن خريطة المنطقة..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-1 p-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition hover-lift"
                        />
                        <button 
                            onClick={handleSearch}
                            className="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center btn-interactive"
                            title="بحث"
                        >
                            <i className="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                {userRole === 'admin' && (
                    <div className="max-w-xl mx-auto my-6 p-4 bg-slate-50 border rounded-lg hover-lift">
                        <button onClick={showForm ? () => setShowForm(false) : handleAddNewClick} className="text-blue-600 font-semibold flex items-center gap-2 btn-interactive">
                            <i className={`fas ${showForm ? 'fa-times' : 'fa-plus'}`}></i>
                            {showForm ? 'إلغاء' : 'إضافة خريطة جديدة'}
                        </button>
                        {showForm && (
                            <div className="mt-4 space-y-3 text-right">
                                <h3 className="text-lg font-semibold">{editingIndex !== null ? 'تعديل الخريطة' : 'إضافة خريطة جديدة'}</h3>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">اسم الخريطة</label>
                                    <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="mt-1 w-full p-2 border rounded-md hover-lift" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700">رابط الخريطة</label>
                                    <input type="text" value={formData.link} onChange={e => setFormData({...formData, link: e.target.value})} className="mt-1 w-full p-2 border rounded-md hover-lift" />
                                </div>
                                <button onClick={handleSaveMap} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 btn-interactive">حفظ الخريطة</button>
                            </div>
                        )}
                    </div>
                )}

                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 mt-8">
                    {filteredMaps.map((map, index) => {
                        const originalIndex = data.maps.findIndex(m => m.name === map.name && m.link === map.link);
                        return (
                        <div key={originalIndex} className="bg-white rounded-lg shadow-md overflow-hidden text-center card-interactive relative group">
                            <a
                                href={map.link}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="block"
                            >
                                <div className="bg-slate-800 text-white font-bold p-2">{index + 1}</div>
                                <div className="p-4 font-semibold text-slate-700">{map.name}</div>
                            </a>
                            {userRole === 'admin' && (
                                <div className="absolute top-1 right-1 z-10 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button 
                                        onClick={() => handleEditClick(originalIndex)}
                                        className="w-6 h-6 bg-yellow-400 text-white rounded-full flex items-center justify-center btn-interactive"
                                        title="تعديل الخريطة"
                                    >
                                        <i className="fas fa-pen text-xs"></i>
                                    </button>
                                    <button 
                                        onClick={() => handleDeleteMap(originalIndex)} 
                                        className="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center btn-interactive"
                                        title="حذف الخريطة"
                                    >
                                        <i className="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            )}
                        </div>
                    )})}
                </div>
                <SaveButton section="الخرائط" />
            </section>
        );
    };
    
    // --- باقي الأقسام (Offers, Vlans, Materials, Maintenance, Ports, Contact) ---
    // سيتم الحفاظ على نفس الكود مع إضافة تحميل البيانات
    
    // --- From sections/Offers.tsx ---
    const EditableCell = ({ value, onSave, isAdmin }) => {
        const handleBlur = (e) => {
            onSave(e.currentTarget.textContent || '');
        };

        return (
            <td
                contentEditable={isAdmin}
                onBlur={handleBlur}
                suppressContentEditableWarning={true}
                className="p-3 border-b border-slate-200 hover:bg-slate-50 transition-colors"
            >
                {value}
            </td>
        );
    };

    const Offers = () => {
        const { data, updateData, isLoading } = useData();
        const { userRole } = useAuth();
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedArea, setSelectedArea] = useState(null);

        if (isLoading) {
            return (
                <div className="container mx-auto px-4 py-12 animate-fade-in flex justify-center items-center h-64">
                    <div className="text-center">
                        <i className="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p className="text-slate-600">جاري تحميل البيانات...</p>
                    </div>
                </div>
            );
        }

        const isAdmin = userRole === 'admin';

        const handleSearch = () => {
            if (data.offers[searchTerm]) {
                setSelectedArea(searchTerm);
            } else {
                setSelectedArea(null);
                if(searchTerm) showToast(`لا توجد عروض للمنطقة: ${searchTerm}`, 'error');
            }
        };
        
        const handleUpdate = (area, offerIndex, field, value, rowIndex, cellIndex) => {
            const newData = JSON.parse(JSON.stringify(data));
            if (field === 'table' && rowIndex !== undefined && cellIndex !== undefined) {
                newData.offers[area][offerIndex].table[rowIndex][cellIndex] = value;
            } else if (field !== 'table') {
                newData.offers[area][offerIndex][field] = value;
            }
            updateData(newData);
        };

        const handleAddRow = (area, offerIndex) => {
            const newData = JSON.parse(JSON.stringify(data));
            newData.offers[area][offerIndex].table.push(["مدة جديدة", "0", "0", "0", "0"]);
            updateData(newData);
        };

        const handleDeleteRow = (area, offerIndex, rowIndex) => {
            const newData = JSON.parse(JSON.stringify(data));
            newData.offers[area][offerIndex].table.splice(rowIndex, 1);
            updateData(newData);
        };

        const handleDeleteOffer = (area, offerIndex) => {
            const newData = JSON.parse(JSON.stringify(data));
            newData.offers[area].splice(offerIndex, 1);
            if(newData.offers[area].length === 0){
                delete newData.offers[area];
                setSelectedArea(null);
            }
            updateData(newData);
        };
        
        const handleAddNewAreaOffer = () => {
            const newArea = prompt("أدخل اسم أو رقم المنطقة الجديدة:");
            if (newArea && !data.offers[newArea]) {
                const newData = JSON.parse(JSON.stringify(data));
                newData.offers[newArea] = [{
                    title: `عرض جديد للمنطقة ${newArea}`,
                    table: [["شهر", "15000", "20000", "30000", "75000"]],
                    note: "ملاحظات العرض الجديد."
                }];
                updateData(newData);
                setSearchTerm(newArea);
                setSelectedArea(newArea);
            } else if (newArea) {
                showToast("هذه المنطقة موجودة بالفعل.", 'error');
            }
        };

        return (
            <section className="container mx-auto px-4 py-12 animate-fade-in">
                <h2 className="text-3xl font-bold text-center mb-12 text-slate-800 relative after:content-[''] after:absolute after:w-20 after:h-1 after:bg-blue-500 after:left-1/2 after:-translate-x-1/2 after:bottom-[-10px] after:rounded-full">العروض المتاحة</h2>
                
                <div className="max-w-xl mx-auto p-6 bg-white rounded-lg shadow-md card-interactive">
                    <label htmlFor="areaNumber" className="block text-lg font-semibold text-slate-700 mb-2">أدخل رقم المنطقة أو اسمها:</label>
                    <input
                        type="text"
                        id="areaNumber"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        className="w-full p-3 border-2 border-slate-300 rounded-lg focus:border-blue-500 hover-lift"
                        placeholder="مثال: 44, 115, مجمع..."
                    />
                    <div className="mt-4 flex flex-col gap-2">
                        <button onClick={handleSearch} className="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition btn-interactive">
                            عرض العروض <i className="fas fa-arrow-left mr-2"></i>
                        </button>
                        {isAdmin && (
                            <button onClick={handleAddNewAreaOffer} className="w-full py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition btn-interactive">
                                إضافة عرض لمنطقة جديدة
                            </button>
                        )}
                    </div>
                </div>

                {selectedArea && (
                    <div className="mt-12 space-y-8">
                        {data.offers[selectedArea].map((offer, offerIndex) => (
                            <div key={offerIndex} className="bg-white rounded-lg shadow-lg p-6 relative group card-interactive">
                                {isAdmin && (
                                    <button onClick={() => handleDeleteOffer(selectedArea, offerIndex)} className="absolute top-3 left-3 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity btn-interactive" title="حذف العرض بالكامل">
                                        <i className="fas fa-trash-alt text-sm"></i>
                                    </button>
                                )}
                                <h3
                                    contentEditable={isAdmin}
                                    onBlur={(e) => handleUpdate(selectedArea, offerIndex, 'title', e.currentTarget.textContent || '')}
                                    suppressContentEditableWarning={true}
                                    className="text-2xl font-bold text-center mb-6 text-slate-800 p-1 rounded-md hover:bg-slate-50 transition-colors"
                                >
                                    {offer.title}
                                    {isAdmin && <i className="fas fa-pen text-xs text-slate-400 mr-2 opacity-0 group-hover:opacity-100"></i>}
                                </h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-center">
                                        <thead className="bg-blue-500 text-white">
                                            <tr>
                                                <th className="p-3">المدة</th>
                                                <th className="p-3">فئة اولى</th>
                                                <th className="p-3">فئة ثانية</th>
                                                <th className="p-3">فئة ثالثة</th>
                                                <th className="p-3">فئة رابعة</th>
                                                {isAdmin && <th className="p-3 w-12"></th>}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {offer.table.map((row, rowIndex) => (
                                                <tr key={rowIndex} className="odd:bg-slate-50 hover:bg-slate-100 transition-colors">
                                                    {row.map((cell, cellIndex) => (
                                                        <EditableCell
                                                            key={cellIndex}
                                                            value={cell}
                                                            isAdmin={isAdmin}
                                                            onSave={(newValue) => handleUpdate(selectedArea, offerIndex, 'table', newValue, rowIndex, cellIndex)}
                                                        />
                                                    ))}
                                                    {isAdmin && (
                                                        <td className="p-3 border-b border-slate-200">
                                                            <button onClick={() => handleDeleteRow(selectedArea, offerIndex, rowIndex)} className="text-red-500 hover:text-red-700 btn-interactive">
                                                                <i className="fas fa-trash-alt"></i>
                                                            </button>
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {isAdmin && (
                                    <div className="text-center mt-4">
                                        <button onClick={() => handleAddRow(selectedArea, offerIndex)} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 btn-interactive">
                                            <i className="fas fa-plus mr-2"></i> إضافة مدة
                                        </button>
                                    </div>
                                )}
                                <div
                                    contentEditable={isAdmin}
                                    onBlur={(e) => handleUpdate(selectedArea, offerIndex, 'note', e.currentTarget.textContent || '')}
                                    suppressContentEditableWarning={true}
                                    className="mt-6 p-4 bg-slate-100 rounded-md text-center text-slate-700 font-semibold hover:bg-slate-200 transition-colors"
                                >
                                    {offer.note}
                                    {isAdmin && <i className="fas fa-pen text-xs text-slate-400 mr-2 opacity-0 group-hover:opacity-100"></i>}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                <SaveButton section="العروض" />
            </section>
        );
    };

    // --- باقي الأقسام سيتم الحفاظ على نفس الهيكل مع إضافة isLoading ---

    // --- From App.tsx ---
    const App = () => {
        const { userRole } = useAuth();
        const [activeSection, setActiveSection] = useState(Section.Home);

        if (!userRole) {
            return <Login />;
        }

        const renderSection = () => {
            switch (activeSection) {
            case Section.Home:
                return <Home setActiveSection={setActiveSection} />;
            case Section.Maps:
                return <Maps />;
            case Section.Offers:
                return <Offers />;
            case Section.Vlans:
                return <Vlans />;
            case Section.Materials:
                return <Materials />;
            case Section.Maintenance:
                return <Maintenance />;
            case Section.Ports:
                return <Ports />;
            case Section.Contact:
                return <Contact />;
            default:
                return <Home setActiveSection={setActiveSection} />;
            }
        };

        return (
            <div className="bg-slate-100 text-slate-800 min-h-screen">
                <Layout activeSection={activeSection} setActiveSection={setActiveSection}>
                    {renderSection()}
                </Layout>
            </div>
        );
    };

    // --- From index.tsx ---
    const rootElement = document.getElementById('root');
    if (!rootElement) {
        throw new Error("Could not find root element to mount to");
    }

    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
    });

    const root = ReactDOM.createRoot(rootElement);
    root.render(
        <React.StrictMode>
            <AuthProvider>
                <DataProvider>
                    <App />
                </DataProvider>
            </AuthProvider>
        </React.StrictMode>
    );
  </script>
</body>
</html>
